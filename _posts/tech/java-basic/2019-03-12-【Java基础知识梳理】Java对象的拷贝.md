---
layout: post
title:  "【Java基础知识梳理】Java对象的拷贝"
date:   2019-03-12 22:30:00 +0800
tags:
        - 技术
        - java
---
# 对象与引用

如下， 我们只是将p1 的地址复制给了p2, 实际引用的还是堆内存中的同一个对象【Person("han",28)】。

```
Person p1 = new Person("han",28);
Person p2 = p1;
 栈（引用）|    堆（对象）
----------|---------------------------
          | 
  p1----------->|------------------|
          |     | Person("han",28) |
  p2----------->|------------------|
          |
          | 
          | 

```

下面的代码才是真正的复制了一个对象。
```
Person p1 = new Person("han",28);
Person p2 = p1.clone();
 栈（引用）|    堆（对象）
----------|---------------------------
          | 
  p1----------->|------------------|
          |     | Person("han",28) |
          |     |------------------|
          |  
          |     |------------------|
  p2----------->| Person("han",28) |
          |     |------------------|
          | 
          | 

```



# Object.clone() 和 Cloneable
先看下Object 中 clone() 方法的定义。 

```
protected native Object clone() throws CloneNotSupportedException;

```

1. clone() 是一个 proctected 方法， 也就是说一个类没有重写clone 方法的话，是无法在其对象上调用clone方法的。 
2. CloneNotSupportedException: 如果子类没有实现 Cloneable 接口， 在子类对调用Object.clone方法会抛出CloneNotSupportedException异常。
3. Cloneable接口： 接口本身没有clone方法， 实现Cloneable接口的类需要重写 Object的clone方法（protected 重写为 public）。



# 深拷贝与浅拷贝
如下，拷贝后仅是最外层的对象在堆内存中有两实例，但对象的嵌套对象属性引用的还是同一个对象，叫做浅拷贝， 反之嵌套属性的对象也各自复制的叫深拷贝。

```

 栈（引用）|    堆（对象）
----------|------------------------------------------------------------
          | 
  p1----------->|------------------|
          |     | Person("han",28) |
          |     |------------------|
          |            |
          |           \|/
          |          "han"                         【浅拷贝】
          |           /|\
          |            |                                                 
          |     |------------------|
  p2----------->| Person("han",28) |
          |     |------------------|
          | 
----------|-----------------------------------------------------------
          | 
  p1----------->|------------------|
          |     | Person("han",28) |----> "han"
          |     |------------------|
          |                                         【深拷贝】              
          |     |------------------|
  p2----------->| Person("han",28) |----> "han"
          |     |------------------|
          | 
          | 
```


## 如何实现深拷贝？
1. 递归地对每一层级属性进行拷贝
2. 通过[java对象的序列化与反序列的方式]()


## 彻底的深拷贝?

- 有时实现彻底的深拷贝是一件不可能完成事。如我们的类中引用的有第三方的类，而第三方类中的没有实现clone方法。 
- 对于不可变对象， 我们完全没有必要去实现拷贝功能。 如 String等jdk中的不可变对象。
